{% extends 'base.html' %}

{% block title %}
  Index!
{% endblock %}


{% block main_content %}
<style>
    .toolbar-cards {
        display: flex;
        flex-wrap: wrap;
      }
      .toolbar-card {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px;
        cursor: pointer;
      }
      .toolbar-card:hover {
        background-color: #f0f0f0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      table, th, td {
        border: 1px solid black;
      }
      th, td {
        padding: 10px;
        text-align: left;
      }

      .modal {
        display: none; 
        position: fixed; 
        z-index: 1; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgb(0,0,0); 
        background-color: rgba(0,0,0,0.4); 
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto; 
        padding: 20px;
        border: 1px solid #888;
        width: 80%; 
    } 

    .btn-default {
        background-color: white;
        color: black;
    }
    .selected {
        background-color: teal;
        color: white;
    }

</style>

  <h2>评价任务</h2>

  <div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div id="card-toolbar" class="card-toolbar clearfix">
                    {% for item in evaluation_items %}
                        <div class="btn m-r-5 btn-default" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}">
                            <span>{{ item.name }}</span>
                        </div>
                    {% endfor %}
                </div>
                <div id="table-container" class="table-responsive"></div>
            </div>
        </div>
    </div>
</div>


<div id="myModal" class="modal">
    <div class="modal-content">
      
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="exampleModalLabel">评价</h4>
        </div>

        <div class="modal-body">
            <form method="POST">
                <label for="eval-item-name">评价项目:</label>
                <input type="text" id="eval-item-name" name="eval-item-name" required>
                <br>
                <label for="eval-item-dimension-name">评价指标:</label>
                <input type="text" id="eval-item-dimension-name" name="eval-item-dimension-name" required>
                <br>
                <label for="eval-class-name">被评价班级:</label>
                <input type="text" id="eval-class-name" name="eval-class-name" required>
                <br>
                <label for="eval-item-starttime">开始日期:</label>
                <input type="date" id="eval-item-starttime" name="eval-item-starttime" required>
                <br>
                <label for="eval-item-endtime">结束日期:</label>
                <input type="date" id="eval-item-endtime" name="eval-item-endtime" required>
                <br>
                <label for="eval-item-looprule">评价循环规则:</label>
                <input type="text" id="eval-item-looprule" name="eval-item-looprule" required>
                <br>
                <button type="submit">提交</button>
            </form>
        </div>
    </div>
</div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const buttons = document.querySelectorAll('.btn[data-item-id]');
        const tableContainer = document.getElementById('table-container');

        buttons.forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有按钮的选中状态
                buttons.forEach(btn => btn.classList.remove('selected'));
                
                // 添加当前按钮的选中状态
                this.classList.add('selected');

                // 获取选中的item id
                const itemId = this.getAttribute('data-item-id');
                const itemname  = this.getAttribute('data-item-name');

                const evaluationItems = {{ evaluation_items_context|safe }};
                // 根据itemId找到对应的item
                const selectedItem = evaluationItems.find(item => item.id === Number(itemId));

                // 将选中的item传递给generateTable函数
                generateTable(selectedItem);
            });
        });


        function generateTable(selectedItem) {
            if (!selectedItem) {
                alert('Warning: Selected item not found!');
                return;
            }
        
            // Clear previous table
            tableContainer.innerHTML = '';
        
            // Create table
            const table = document.createElement('table');
            table.classList.add('table');
        
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            first_header = document.createElement('th')
            first_header.textContent = '班级';
            first_header.style.textAlign = 'center';
            headerRow.appendChild(first_header);
            selectedItem.dimensions.forEach(dimension => {
                const th = document.createElement('th');
                th.textContent = dimension.name;
                th.style.textAlign = 'center';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // create href

            var modal = document.getElementById("myModal");
            var span = document.getElementsByClassName("close")[0];
        
            span.onclick = function() {
            modal.style.display = "none";
            }
        
            window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            }
        
            // Create table body
            const tbody = document.createElement('tbody');
            selectedItem.evaluate_classes.forEach(class_ => {
                const row = document.createElement('tr');
                const td = document.createElement('td');
                td.textContent = class_.name;
                td.style.textAlign = 'center'
                row.appendChild(td);
                selectedItem.dimensions.forEach(dimension => {
                    const td = document.createElement('td');
                    td.style.textAlign = 'center';
                    var val_button = document.createElement('a');
                    val_button.href = "javascript:;"
                    val_button.textContent = '评价';
                    val_button.setAttribute('eval-item-name', selectedItem.name);
                    val_button.setAttribute('eval-item-dimension-name', dimension.name);
                    val_button.setAttribute('eval-class-name',class_.name);
                    val_button.setAttribute('eval-item-starttime',selectedItem.start_date);
                    val_button.setAttribute('eval-item-endtime',selectedItem.end_date);
                    val_button.setAttribute('eval-item-looprule',selectedItem.loop_rule);
                    val_button.setAttribute('class' , 'evaluate-link');
                    val_button.onclick = function() {
                        modal.style.display = "block";
                    }
                    td.appendChild(val_button);
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            // Append table to container
            tableContainer.appendChild(table);
        }
    });
</script>


{% endblock %}
